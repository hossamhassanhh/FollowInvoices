<style>
    .auto-fit-input {
        text-align: center;
        font-size: larger;
        font-weight: bolder;
        margin-bottom: 10px;
        border-radius: 20px;
        padding: 8px 16px;
        width: auto;
        display: inline-block;
        min-width: 100px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        box-sizing: border-box;
    }
    @@media print {
        body *

    {
        visibility: hidden;
    }

    #printArea,
    #printArea * {
        visibility: visible;
    }

    #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        direction: rtl;
    }

        .print-header {
            display: flex;
            justify-content: flex-end; /* يمين الصفحة */
            align-items: center;
            gap: 10px;
            direction: rtl;
            text-align: right;
            padding: 5px 10px;
        }

            .print-header img {
                height: 60px;
            }

            .print-header h2 {
                margin: 0;
                font-size: 18px;
                white-space: nowrap;
            }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }

    th, td {
        border: 1px solid #000;
        padding: 4px;
    }

    }
</style>
@{
    // Cast the ViewBag data to a DataTable
    System.Data.DataTable dataTable = ViewBag.DataTable;

    // Determine which columns have at least one non-empty/non-null value
    var visibleColumns = new List<System.Data.DataColumn>();
    if (dataTable != null)
    {
        foreach (System.Data.DataColumn col in dataTable.Columns)
        {
            bool hasValue = false;
            foreach (System.Data.DataRow row in dataTable.Rows)
            {
                var cellValue = row[col];
                if (cellValue != DBNull.Value && !string.IsNullOrWhiteSpace(cellValue?.ToString()))
                {
                    hasValue = true;
                    break;
                }
            }
            if (hasValue)
            {
                visibleColumns.Add(col);
            }
        }
    }
    // Function to convert English digits to Arabic digits
    string ToArabicDigits(object input)
    {
        if (input == null || input == DBNull.Value)
            return string.Empty;

        string text = input.ToString().Trim();
        if (string.IsNullOrEmpty(text) || text == "null")
            return string.Empty;

        var cultureAr = new System.Globalization.CultureInfo("ar-EG");
        var cultureEn = System.Globalization.CultureInfo.InvariantCulture;

        // 1️⃣ Check if numeric (decimal or integer)
        if (decimal.TryParse(text, System.Globalization.NumberStyles.Any, cultureEn, out decimal numberValue))
        {
            string numText = numberValue.ToString(cultureEn);
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in numText)
            {
                if (char.IsDigit(c))
                    sb.Append(arabicDigits[c - '0']);
                else if (c == '.')
                    sb.Append('٫'); // Arabic decimal separator
                else if (c == ',')
                    sb.Append('٬'); // Arabic thousands separator
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }

        // 2️⃣ Check if it's a DateTime (Arabic or English)
        DateTime dateValue;
        bool isDate =
            DateTime.TryParse(text, cultureEn, System.Globalization.DateTimeStyles.None, out dateValue) ||
            DateTime.TryParse(text, cultureAr, System.Globalization.DateTimeStyles.None, out dateValue);

        if (isDate)
        {
            // Format date formally in Egyptian Arabic
            string formattedDate = dateValue.ToString("dddd، dd MMMM yyyy", cultureAr);

            // Convert digits to Arabic-Indic
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in formattedDate)
            {
                if (char.IsDigit(c))
                    sb.Append(arabicDigits[c - '0']);
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }

        // 3️⃣ Otherwise return text as is
        else
        {
            string cultureText = text.ToString(cultureEn);
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in cultureText)
            {
                if (char.IsDigit(c) && !arabicDigits.Contains(c))
                    sb.Append(arabicDigits[c - '0']);
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }
    }

}

<!DOCTYPE html>
<html>
<head>
    <script src="/js/jspdf.umd.min.js"></script>
    <script src="/js/jspdf.plugin.autotable.js"></script>
    <script src="/js/xlsx.full.min.js"></script>
</head>
<body>    
    @* <div style="position: center;">

        <input class="auto-fit-input" value="@ViewBag.ViewName" disabled />
        @{
            if (!string.IsNullOrEmpty(ViewBag.FilterDate))
            {
                <input class="auto-fit-input" value="@ViewBag.FilterDate" disabled />
            }
        }
    </div> *@
    <div id="printArea">

        <div class="table-container">
            @if (dataTable != null && dataTable.Rows.Count > 0 && visibleColumns.Count > 0)
            {
                <table id="dataTable">

                    
                    <thead>
                        <tr>
                            <th colspan="4" style="border:none;">
                                <div class="print-header">
                                    <img src="/Images/pms-logo.png" height="60" />
                                    <h2>شركة خدمات البترول البحرية</h2>
                                </div>
                            </th>
                            @* <th colspan="2" style="border:none;">
                                <div class="print-header">
                                    <h2>شركة خدمات البترول البحرية</h2>
                                </div>
                            </th> *@
                            @* <th colspan="2" style="border:solid; background-color: steelblue !important; color: whitesmoke;">
                                <div class="print-header">
                                    <h2>
                                        @ViewBag.ViewName
                                    </h2>
                                </div>
                            </th> *@
                            <th colspan="@visibleColumns.Count" style="border:none;"></th>
                        </tr>
                        <tr>
                            <th colspan="@visibleColumns.Count/2" style="border: none;">
                                <div class="print-header">
                                    <h2>
                                        @ViewBag.ViewName
                                    </h2>
                                    @{
                                        if (!string.IsNullOrEmpty(ViewBag.FilterDate))
                                        {
                                            <h2>@ViewBag.FilterDate</h2>
                                        }
                                    }
                                </div>
                            </th>
                            <th colspan="@visibleColumns.Count" style="border:none;"></th>
                        </tr>
                        <tr>
                            @foreach (var col in visibleColumns.AsEnumerable().Reverse())
                            {
                                <th>@col.ColumnName</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (System.Data.DataRow row in dataTable.Rows)
                        {
                            <tr>
                                @foreach (var col in visibleColumns.AsEnumerable().Reverse())
                                {
                                    <td>@Html.Raw(row[col])</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>غير مسجل</p>
            }
        </div>

    </div>
    

    <div class="button-container" style="margin-bottom: 20px;">
        <button class="custom-btn" onclick="printTable()">طباعة الجدول</button>
        <button class="custom-btn" onclick="exportExcel()">تصدير كـ Excel</button>
        <button class="custom-btn" onclick="GoToHomePage()">الرجوع إلي القائمة الرئيسية</button>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.auto-fit-input');

            inputs.forEach(input => {
                // Create a temporary span to measure text width
                const tempSpan = document.createElement('span');
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.whiteSpace = 'pre';
                tempSpan.style.font = window.getComputedStyle(input).font;
                tempSpan.textContent = input.value || ' ';

                document.body.appendChild(tempSpan);
                const textWidth = tempSpan.offsetWidth;
                document.body.removeChild(tempSpan);

                // Set input width to text width + padding
                input.style.width = (textWidth + 42) + 'px'; // 32px for padding (16px left + 16px right)
            });
        });
    </script>
    <script>
        function GoToHomePage() {
            var url = '@Url.Action("Index", "Home")';
            window.location.href = url;
        }

        function printTable() {
            window.print();
        }
        // function printTable() {
        //     // Create a new window for printing
        //     const printWindow = window.open('', '_blank');

        //     // Get the HTML content you want to print
        //     const content = document.body.innerHTML;
        //      printWindow.document.write(content);
        //      printWindow.document.close();
        // }
        function exportExcel() {
            const table = document.getElementById("dataTable");
            const workbook = XLSX.utils.book_new();
            const worksheetData = [];

            for (let row of table.rows) {
                const rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText);
                }
                worksheetData.push(rowData);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "table-data.xlsx");
        }
    </script>
</body>
</html>