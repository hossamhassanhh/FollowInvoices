@{
    // Cast the ViewBag data to a DataTable
    System.Data.DataTable dataTable = ViewBag.DataTable;

    // Determine which columns have at least one non-empty/non-null value
    var visibleColumns = new List<System.Data.DataColumn>();
    if (dataTable != null)
    {
        foreach (System.Data.DataColumn col in dataTable.Columns)
        {
            bool hasValue = false;
            foreach (System.Data.DataRow row in dataTable.Rows)
            {
                var cellValue = row[col];
                if (cellValue != DBNull.Value && !string.IsNullOrWhiteSpace(cellValue?.ToString()))
                {
                    hasValue = true;
                    break;
                }
            }
            if (hasValue)
            {
                visibleColumns.Add(col);
            }
        }
    }
    // Function to convert English digits to Arabic digits
    string ToArabicDigits(object input)
    {
        if (input == null || input == DBNull.Value)
            return string.Empty;

        string text = input.ToString().Trim();
        if (string.IsNullOrEmpty(text) || text == "null")
            return string.Empty;

        var cultureAr = new System.Globalization.CultureInfo("ar-EG");
        var cultureEn = System.Globalization.CultureInfo.InvariantCulture;

        // 1️⃣ Check if numeric (decimal or integer)
        if (decimal.TryParse(text, System.Globalization.NumberStyles.Any, cultureEn, out decimal numberValue))
        {
            string numText = numberValue.ToString(cultureEn);
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in numText)
            {
                if (char.IsDigit(c))
                    sb.Append(arabicDigits[c - '0']);
                else if (c == '.')
                    sb.Append('٫'); // Arabic decimal separator
                else if (c == ',')
                    sb.Append('٬'); // Arabic thousands separator
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }

        // 2️⃣ Check if it's a DateTime (Arabic or English)
        DateTime dateValue;
        bool isDate =
            DateTime.TryParse(text, cultureEn, System.Globalization.DateTimeStyles.None, out dateValue) ||
            DateTime.TryParse(text, cultureAr, System.Globalization.DateTimeStyles.None, out dateValue);

        if (isDate)
        {
            // Format date formally in Egyptian Arabic
            string formattedDate = dateValue.ToString("dddd، dd MMMM yyyy", cultureAr);

            // Convert digits to Arabic-Indic
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in formattedDate)
            {
                if (char.IsDigit(c))
                    sb.Append(arabicDigits[c - '0']);
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }

        // 3️⃣ Otherwise return text as is
        else
        {
            string cultureText = text.ToString(cultureEn);
            var arabicDigits = new[] { '٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩' };
            var sb = new System.Text.StringBuilder();

            foreach (char c in cultureText)
            {
                if (char.IsDigit(c) && !arabicDigits.Contains(c))
                    sb.Append(arabicDigits[c - '0']);
                else
                    sb.Append(c);
            }

            return sb.ToString();
        }
    }

}

<!DOCTYPE html>
<html>
<head>
    <script src="/js/jspdf.umd.min.js"></script>
    <script src="/js/jspdf.plugin.autotable.js"></script>
    <script src="/js/xlsx.full.min.js"></script>
</head>
<body>
    <div class="table-container">
        @if (dataTable != null && dataTable.Rows.Count > 0 && visibleColumns.Count > 0)
        {
            <table id="dataTable">
                <thead>
                    <tr>
                        @foreach (var col in visibleColumns.AsEnumerable().Reverse())
                        {
                            <th>@col.ColumnName</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (System.Data.DataRow row in dataTable.Rows)
                    {
                        <tr>
                            @foreach (var col in visibleColumns.AsEnumerable().Reverse())
                            {
                                <td>@Html.Raw(ToArabicDigits(row[col]))</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>غير مسجل</p>
        }
    </div>

    <div class="button-container" style="margin-bottom: 20px;">
        <button class="custom-btn" onclick="printTable()">طباعة الجدول</button>
        <button class="custom-btn" onclick="exportExcel()">تصدير كـ Excel</button>
        <button class="custom-btn" onclick="GoToHomePage()">الرجوع إلي القائمة الرئيسية</button>
    </div>

    <script>
        function GoToHomePage() {
            var url = '@Url.Action("Index", "Home")';
            window.location.href = url;
        }

        function printTable() {
            window.print();
        }

        function exportExcel() {
            const table = document.getElementById("dataTable");
            const workbook = XLSX.utils.book_new();
            const worksheetData = [];

            for (let row of table.rows) {
                const rowData = [];
                for (let cell of row.cells) {
                    rowData.push(cell.innerText);
                }
                worksheetData.push(rowData);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
            XLSX.writeFile(workbook, "table-data.xlsx");
        }
    </script>
</body>
</html>