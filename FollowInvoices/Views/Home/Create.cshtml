<style>
    .custom-select-container {
        position: relative;
        width: 100%;
        direction: rtl;
        text-align: right;
    }

    .search-box {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    .options-list {
        position: absolute;
        z-index: 10;
        width: 100%;
        max-height: 150px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #ccc;
        border-top: none;
        display: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

        .options-list div {
            padding: 8px;
            cursor: pointer;
        }

            .options-list div:hover {
                background-color: #f2f2f2;
            }
</style>
<div class="form-container">
    <div class="input-wrapper">
        <label>اسم المستخدم</label>
        <input type="text" id="user-name" value="@User.Identity.Name" disabled/>
    </div>
    <div class="input-wrapper">
        <label>رقم الايزو</label>
        <input type="text" id="iso-number" value="@ViewBag.NextIsoNumber" oninput="updateInvoiceNumber()" />
    </div>
    <div class="input-wrapper">
        <label>تاريخ الايزو</label>
        <input type="text" id="iso-date" value="@ViewBag.IsoDate" />
    </div>
    <div class="input-wrapper">
        <label>رقم الفاتورة</label>
        <div class="div-container">
            <input type="text" id="invoice-number" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
            <button class="btn" onclick="updateInvoiceData()">استعلام</button>
            <button class="btn" onclick="ResetInvoiceData()">ادخال فاتورة جديدة</button>
        </div>
    </div>
    @* <div class="input-wrapper">
        <label>المورد</label>
        <select id="vendor-dropdown" required>
            <option value="">اختر المورد</option>
        </select>
    </div> *@
    <div class="input-wrapper">
        <label>المورد</label>
        <div class="custom-select-container" id="vendor-container">
            <input type="text" id="vendorSearch" class="search-box" placeholder="اختر المورد..." readonly required />
            <div id="vendorOptions" class="options-list"></div>
        </div>
    </div>
    
    <div class="input-wrapper">
        <label>مبلغ الفاتورة ١</label>
        <input type="text" id="invoice-value-1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
    </div>
    <div class="input-wrapper">
        <label for="currency-1">العملة ١</label>
        <select id="currency-1" required>
            <option value="" selected></option>
            <option value="جنيه مصرى">جنيه مصرى</option>
            <option value="دولار امريكي">دولار امريكي</option>
            <option value="يورو">يورو</option>
            <option value="جنيه استرليني">جنيه استرليني</option>
            <option value="ریال سعودی">ریال سعودی</option>
            <option value="کرونه نرویجی">کرونه نرویجی</option>
            <option value="ین يابانی">ین يابانی</option>
        </select>
    </div>
    <div class="input-wrapper">
        <label>مبلغ الفاتورة ٢</label>
        <input type="text" id="invoice-value-2" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" required>
    </div>
    <div class="input-wrapper">
        <label>العملة ٢</label>
        <select id="currency-2" required>
            <option value="" selected></option>
            <option value="جنيه مصرى">جنيه مصرى</option>
            <option value="دولار امريكي">دولار امريكي</option>
            <option value="يورو">يورو</option>
            <option value="جنيه استرليني">جنيه استرليني</option>
            <option value="ریال سعودی">ریال سعودی</option>
            <option value="کرونه نرویجی">کرونه نرویجی</option>
            <option value="ین يابانی">ین يابانی</option>
        </select>
    </div>
    <div class="input-wrapper">
        <label>تاريخ الفاتورة</label>
        <input class="input" type="date" id="invoice-date" lang="ar" required>
    </div>
    <div class="input-wrapper">
        <label>تاريخ استلام الفاتورة</label>
        <input class="input" type="date" id="invoice-receipt-date" lang="ar" required>
    </div>   
    <div class="input-wrapper">
        <label>الجهة الطالبة</label>
        <select id="requester" required>
            <option value="" selected></option>
            <option value="العلاقات العامة">العلاقات العامة</option>
            <option value="المشرعات القاهرة">المشرعات القاهرة</option>
            <option value="المشرعات">المشرعات</option>
            <option value="المشروعات ١">المشروعات ١</option>
            <option value="الطبية">الطبية</option>
            <option value="الاعمال البحرية">الاعمال البحرية</option>
            <option value="التشغيل والصيانة">التشغيل والصيانة</option>
            <option value="الادارية">الادارية</option>
            <option value="القانونية">القانونية</option>
            <option value="منطقة الاسكندرية">منطقة الاسكندرية</option>
            <option value="المساحة والغطس">المساحة والغطس</option>
            <option value="تكنولوجيا المعلومات">تكنولوجيا المعلومات</option>
            <option value="المالية">المالية</option>
            <option value="الوحدات الديناميكية">الوحدات الديناميكية</option>
            <option value="الوحدات الغير الديناميكية">الوحدات الغير الديناميكية</option>
            <option value="التخطيط">التخطيط</option>
            <option value="المشتريات الاسكندرية">المشتريات الاسكندرية</option>
            <option value="الجمارك">الجمارك</option>
        </select>
    </div>
    <div class="input-wrapper" id="to-requester-div" style="display: none;">
        <label>تاريخ الارسال للجهة الطالبة</label>
        <input class="input" type="date" id="to-requester-date" lang="ar">
    </div>
    @* <div class="input-wrapper">
        <label for="back-to-requester">ارجاع الي الجهة الطالبة</label>
        <select id="back-to-requester">
            <option value="" selected></option>
            <option value="لا">لا</option>
            <option value="نعم">نعم</option>
        </select>
    </div>

    <div class="input-wrapper" id="to-requester-div" style="display: none;">
        <label>تاريخ الارسال للجهة الطالبة</label>
        <input class="input" type="date" id="to-requester-date" lang="ar">
    </div> *@
    <div class="input-wrapper">
        <label for="area">الموقع</label>
        <select id="area" required>
            <option value="" selected></option>
            <option value="الرئيسي">الرئيسي</option>
            <option value="المعدية">المعدية</option>
        </select>
    </div>
    <div class="button-container">
        <button class="custom-btn" onclick="RedirectToExecuteCreateAction()">تنفيذ</button>
        <button class="custom-btn" onclick="RedirectToExecuteEditAction()">تعديل</button>
        <button class="custom-btn" onclick="GoToHomePage()">الرجوع إلي القائمة الرئيسية</button>
    </div>
</div>


<script src="/js/jquery-3.7.1.min.js"></script>

<script>
    // Get both elements
    const select = document.getElementById('back-to-requester');
    const dateDiv = document.getElementById('to-requester-div');

    // Listen for changes in the dropdown
    select.addEventListener('change', function () {
        if (this.value === "نعم") {
            dateDiv.style.display = 'block'; // show div
        } else {
            dateDiv.style.display = 'none'; // hide div
            document.getElementById('to-requester-date').value = ''; // optional: clear date
        }
    });
</script>
<script type="text/javascript">

    const invoiceNumber = document.getElementById('invoice-number');

    function EmptyField(elementId) {
        var element = document.getElementById(elementId);
        console.log(element);
        if (!element) {
            console.error(`Element with ID ${elementId} not found.`);
            return;
        }

        // Check if the element is a select dropdown
        if (element.tagName === 'SELECT') {
            element.parentNode.replaceChild(invoiceNumber, element);
            console.log(element);
        }
        // Check if the element is an input, textarea, or other input-like element
        else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.value = '';
        }
        // Handle other cases (e.g., div, span, etc.)
        else {
            console.error(`Unsupported element type: ${element.tagName}`);
        }
    }
    // 
    function ResetFieldValue(elementId) {
        var element = document.getElementById(elementId);
        console.log(element);
        if (!element) {
            console.error(`Element with ID ${elementId} not found.`);
            return;
        }

        // Check if the element is a select dropdown
        if (element.tagName === 'SELECT') {
            element.selectedIndex = 0; // Resets to the first option
            console.log(element);
        }
        // Check if the element is an input, textarea, or other input-like element
        else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.value = '';
        }
        // Handle other cases (e.g., div, span, etc.)
        else {
            console.error(`Unsupported element type: ${element.tagName}`);
        }
    }
    function ResetInvoiceData(){
        EmptyField('invoice-number');
        ResetFieldValue('vendor-dropdown');
        ResetFieldValue('invoice-value-1');
        ResetFieldValue('invoice-value-2');
        ResetFieldValue('invoice-value-3');
        ResetFieldValue('currency-1');
        ResetFieldValue('currency-2');
        ResetFieldValue('currency-3');
        ResetFieldValue('invoice-date');
        ResetFieldValue('invoice-receipt-date');
        ResetFieldValue('requester');
        ResetFieldValue('back-to-requester');
        ResetFieldValue('to-requester-date');
        ResetFieldValue('area');
    }
    function getElementValue(elementId) {
        const element = document.getElementById(elementId);

        if (!element) {
            console.error(`Element with ID ${elementId} not found.`);
            return null;
        }

        // Check if the element is a select dropdown
        if (element.tagName === 'SELECT') {
            return element.options[element.selectedIndex]?.value || '';
        }
        // Check if the element is an input, textarea, or other input-like element
        else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            return element.value;
        }
        // Handle other cases (e.g., div, span, etc.)
        else {
            console.error(`Unsupported element type: ${element.tagName}`);
            return null;
        }
    }

    function setElementValue(elementId, value) {
        const element = document.getElementById(elementId);

        if (!element) {
            console.error(`Element with ID ${elementId} not found.`);
            return;
        }

        // Check if the element is a select dropdown
        if (element.tagName === 'SELECT') {
            // Loop through options and set the selected option
            for (let option of element.options) {
                if (option.value === value) {
                    option.selected = true;
                    break;
                }
            }
        }
        // Check if the element is an input, textarea, or other input-like element
        else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            element.value = value;
        }
        // Handle other cases (e.g., div, span, etc.)
        else {
            console.error(`Unsupported element type: ${element.tagName}`);
        }
    }

    function GoToHomePage() {
        var url = '@Url.Action("Index", "Home")';
        window.location.href = url;
    }

    function RedirectToExecuteEditAction() {
        var userName = getElementValue('user-name'); /* document.getElementById('user-name').value; */
        var isoNumber = getElementValue('iso-number');/* document.getElementById('iso-number').value; */
        var isoDate = getElementValue('iso-date');/* document.getElementById('iso-date').value; */
        var invoiceNumber = getElementValue('invoice-number');/* document.getElementById('invoice-number').value; */
        var invoiceValue1 = getElementValue('invoice-value-1');/* document.getElementById('invoice-value-1').value; */
        var invoiceValue2 = getElementValue('invoice-value-2');/* document.getElementById('invoice-value-2').value; */
        var invoiceValue3 = getElementValue('invoice-value-3');/* document.getElementById('invoice-value-3').value; */
        var currency1 = getElementValue('currency-1');/* document.getElementById('currency-1').value; */
        var currency2 = getElementValue('currency-2'); /* document.getElementById('currency-2').value; */
        var currency3 = getElementValue('currency-3');/* document.getElementById('currency-3').value; */
        var invoiceDate = getElementValue('invoice-date');/* document.getElementById('invoice-date').value; */
        var invoiceReceiptDate = getElementValue('invoice-receipt-date');/* document.getElementById('invoice-receipt-date').value; */
        var requester = getElementValue('requester');/* document.getElementById('requester').value; */

        // var vendorName = getElementValue('vendor-dropdown');/* document.getElementById('vendor-name').value; */
        var vendorName = getSelectedVendor();

        let backToRequester = document.getElementById('back-to-requester').value;
        let toRequesterDate = document.getElementById('to-requester-date').value;
        let area = document.getElementById('area').value;
        
        var url = '@Url.Action("ExecuteEdit", "Home")' +
            '?userName=' + encodeURIComponent(userName) +
            '&isoNumber=' + encodeURIComponent(isoNumber) +
            '&isoDate=' + encodeURIComponent(isoDate) +
            '&invoiceNumber=' + encodeURIComponent(invoiceNumber) +
            '&invoiceValue1=' + encodeURIComponent(invoiceValue1) +
            '&invoiceValue2=' + encodeURIComponent(invoiceValue2) +
            '&invoiceValue3=' + encodeURIComponent(invoiceValue3) +
            '&currency1=' + encodeURIComponent(currency1) +
            '&currency2=' + encodeURIComponent(currency2) +
            '&currency3=' + encodeURIComponent(currency3) +
            '&invoiceDate=' + encodeURIComponent(invoiceDate) +
            '&invoiceReceiptDate=' + encodeURIComponent(invoiceReceiptDate) +
            '&requester=' + encodeURIComponent(requester) +            
            '&vendorName=' + encodeURIComponent(vendorName) +
            '&backToRequester=' + encodeURIComponent(backToRequester) +
            '&toRequesterDate=' + encodeURIComponent(toRequesterDate) +
            '&area=' + encodeURIComponent(area);
            // '&invoiceValues=' + invoiceValues.join(',') +
            // '&currencies=' + currencies.join(',') +

        window.location.href = url;
    }

    function RedirectToExecuteCreateAction() {

        var userName = getElementValue('user-name'); /* document.getElementById('user-name').value; */
        var isoNumber = getElementValue('iso-number');/* document.getElementById('iso-number').value; */
        var isoDate = getElementValue('iso-date');/* document.getElementById('iso-date').value; */
        var invoiceNumber = getElementValue('invoice-number');/* document.getElementById('invoice-number').value; */
        var invoiceValue1 = getElementValue('invoice-value-1');/* document.getElementById('invoice-value-1').value; */
        var invoiceValue2 = getElementValue('invoice-value-2');/* document.getElementById('invoice-value-2').value; */
        var invoiceValue3 = getElementValue('invoice-value-3');/* document.getElementById('invoice-value-3').value; */
        var currency1 = getElementValue('currency-1');/* document.getElementById('currency-1').value; */
        var currency2 = getElementValue('currency-2'); /* document.getElementById('currency-2').value; */
        var currency3 = getElementValue('currency-3');/* document.getElementById('currency-3').value; */
        var invoiceDate = getElementValue('invoice-date');/* document.getElementById('invoice-date').value; */
        var invoiceReceiptDate = getElementValue('invoice-receipt-date');/* document.getElementById('invoice-receipt-date').value; */
        var requester = getElementValue('requester');/* document.getElementById('requester').value; */
        // var vendorName = getElementValue('vendor-dropdown');/* document.getElementById('vendor-name').value; */
        var vendorName = getSelectedVendor();
        let sendToRequesterDate = document.getElementById('to-requester-date').value;
        let area = document.getElementById('area').value;

        var url = '@Url.Action("ExecuteCreate", "Home")' +
            '?userName=' + encodeURIComponent(userName) +
            '&isoNumber=' + encodeURIComponent(isoNumber) +
            '&isoDate=' + encodeURIComponent(isoDate) +
            '&invoiceNumber=' + encodeURIComponent(invoiceNumber) +
            '&invoiceValue1=' + encodeURIComponent(invoiceValue1) +
            '&invoiceValue2=' + encodeURIComponent(invoiceValue2) +
            '&invoiceValue3=' + encodeURIComponent(invoiceValue3) +
            '&currency1=' + encodeURIComponent(currency1) +
            '&currency2=' + encodeURIComponent(currency2) +
            '&currency3=' + encodeURIComponent(currency3) +
            '&invoiceDate=' + encodeURIComponent(invoiceDate) +
            '&invoiceReceiptDate=' + encodeURIComponent(invoiceReceiptDate) +
            '&requester=' + encodeURIComponent(requester) +
            '&vendorName=' + encodeURIComponent(vendorName) +
            '&sendToRequesterDate=' + encodeURIComponent(sendToRequesterDate) +
            '&area=' + encodeURIComponent(area);
        // '&invoiceValues=' + invoiceValues.join(',') +
        // '&currencies=' + currencies.join(',') +

        window.location.href = url;

        // // Construct dynamic invoice values and currencies
        // var exchangeCase = document.getElementById('exchange-case').value; // Number of values (1, 2, or 3)
        // var invoiceValues = [];
        // var currencies = [];

        // for (let i = 1; i <= exchangeCase; i++) {
        //     var valueInput = document.getElementById(`invoice-value-${i}`);
        //     var currencyInput = document.getElementById(`currency-${i}`);

        //     if (valueInput && currencyInput) {
        //         invoiceValues.push(encodeURIComponent(valueInput.value));
        //         currencies.push(encodeURIComponent(currencyInput.value));
        //     }
        // }        
    }

    function updateInvoiceNumber() {
        var isoNumber = document.getElementById('iso-number').value;
        var invoiceInput = document.getElementById('invoice-number');
        var invoiceDropdown = document.createElement('select');
        ResetFieldValue('invoice-number');
        if (isoNumber) {
            // Perform AJAX call to fetch invoice numbers
            $.ajax({
                url: '/Home/GetInvoiceNumbers', // Adjust as per your route
                type: 'GET',
                data: { isoNumber: isoNumber },
                success: function (response) {                    
                    // Check the length of the response
                    if (response.length > 1) {
                        invoiceDropdown.id = invoiceInput.id; // Preserve the ID for compatibility

                        // Add a placeholder option
                        const placeholderOption = document.createElement('option');
                        placeholderOption.value = '';
                        placeholderOption.textContent = 'Select an invoice';
                        placeholderOption.disabled = true;
                        placeholderOption.selected = true;
                        invoiceDropdown.appendChild(placeholderOption);

                        // Populate dropdown with invoice numbers
                        response.forEach(invoice => {
                            const option = document.createElement('option');
                            option.value = invoice;
                            option.textContent = invoice;
                            invoiceDropdown.appendChild(option);
                        });
                        
                    } else if (response.length === 1) {
                        invoiceDropdown = document.createElement('input');
                        invoiceDropdown.type = 'text';
                        invoiceDropdown.id = invoiceInput.id;
                        // Set the single invoice number as the value of the input field
                        invoiceDropdown.value = response[0];
                    } else {
                        invoiceDropdown = document.createElement('input');
                        invoiceDropdown.type = 'text';
                        invoiceDropdown.id = invoiceInput.id;
                        invoiceDropdown.value = '';
                        // No invoice numbers found
                        // console.error('No invoice numbers found for the given ISO number.');
                    }
                    // Replace the original input with the dropdown
                    invoiceInput.parentNode.replaceChild(invoiceDropdown, invoiceInput);
                },
                error: function (xhr, status, error) {
                    alert('Error fetching invoice numbers. Please try again.');
                }
            });
        } else {
            alert('Please enter a valid ISO number.');
        }
    }

    function updateInvoiceData() {
        const isoNumber = getElementValue('iso-number');
        const invoiceNumber = getElementValue('invoice-number');

        if (invoiceNumber !== '') {
            // Perform AJAX call to fetch invoice details
            $.ajax({
                url: '/Home/GetInvoiceData', // Replace with your controller and action
                type: 'GET',
                data: { isoNumber: isoNumber, invoiceNumber: invoiceNumber },
                success: function (response) {
                    // Update fields with the fetched data
                    const responseDetails = response.details;
                    // Use the generic function to set values
                    ResetFieldValue('currency-1');
                    ResetFieldValue('currency-2');
                    ResetFieldValue('currency-3');
                    ResetFieldValue('invoice-value-1');
                    ResetFieldValue('invoice-value-2');
                    ResetFieldValue('invoice-value-3');
                    ResetFieldValue('vendor-dropdown');
                    ResetFieldValue('invoice-date');
                    ResetFieldValue('invoice-receipt-date');
                    ResetFieldValue('requester');
                    ResetFieldValue('iso-date');
                    setElementValue('currency-1', responseDetails.currency1);
                    setElementValue('currency-2', responseDetails.currency2);
                    setElementValue('currency-3', responseDetails.currency3);
                    setElementValue('invoice-value-1', responseDetails.invoiceValue1);
                    setElementValue('invoice-value-2', responseDetails.invoiceValue2);
                    setElementValue('invoice-value-3', responseDetails.invoiceValue3);
                    setElementValue('vendor-dropdown', responseDetails.vendorName);
                    setElementValue('invoice-date', responseDetails.invoiceDate);
                    setElementValue('invoice-receipt-date', responseDetails.invoiceReceiptDate);
                    setElementValue('requester', responseDetails.requester);
                    setElementValue('iso-date', responseDetails.isoDate);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching invoice data:', error);
                    alert('Error fetching invoice data. Please try again.');
                }
            });
        } else {
            alert('رقم الفاتورة غير موجود');
        }
    }

    window.addEventListener("pageshow", function (event) {
        if (event.persisted || window.performance.getEntriesByType("navigation")[0].type === "back_forward") {
            location.reload(); // Forces the page to refresh and clear form values
        }
    });

    $(document).ready(function () {
        populateVendorDropdown();
    });

    function populateVendorDropdown() {
        $.ajax({
            url: '/Home/GetAllVendors',
            type: 'GET',
            success: function (vendors) {
                console.log('checkpoint');
                let vendorDropdown = $("#vendor-dropdown");
                console.log(vendorDropdown);
                vendorDropdown.empty();  // Clear existing options
                vendorDropdown.append('<option value="">اختر المورد</option>'); // Default option

                vendors.forEach(vendor => {
                    vendorDropdown.append(new Option(vendor, vendor));
                    console.log(vendor);
                });
                console.log(vendorDropdown);
            },
            error: function () {
                console.error('Error fetching vendors.');
            }
        });
    }
        // Global array to hold vendor names
    let vendorList = [];

    function populateVendorDropdown() {
        $.ajax({
            url: '/Home/GetAllVendors',
            type: 'GET',
            success: function (vendors) {
                vendorList = vendors; // Store for filtering
                setupSearchableVendor(vendorList);
            },
            error: function () {
                console.error('Error fetching vendors.');
            }
        });
    }

    function setupSearchableVendor(vendors) {
        const vendorSearch = document.getElementById("vendorSearch");
        const vendorOptions = document.getElementById("vendorOptions");

        // Populate vendor list dynamically
        function renderVendors(filter = "") {
            vendorOptions.innerHTML = "";
            const filtered = vendors.filter(v => v.includes(filter));
            filtered.forEach(v => {
                const div = document.createElement("div");
                div.textContent = v;
                div.onclick = () => {
                    vendorSearch.value = v;
                    vendorSearch.dataset.value = v;
                    vendorOptions.style.display = "none";
                    vendorSearch.setAttribute("readonly", true);
                };
                vendorOptions.appendChild(div);
            });
            vendorOptions.style.display = filtered.length ? "block" : "none";
        }

        // Show options when clicking input
        vendorSearch.addEventListener("click", () => {
            vendorSearch.removeAttribute("readonly");
            renderVendors();
            vendorOptions.style.display = "block";
            vendorSearch.focus();
        });

        // Filter list as user types
        vendorSearch.addEventListener("input", (e) => {
            renderVendors(e.target.value.trim());
        });

        // Hide dropdown when clicking outside
        document.addEventListener("click", (e) => {
            if (!e.target.closest("#vendor-container")) {
                vendorOptions.style.display = "none";
                vendorSearch.setAttribute("readonly", true);
            }
        });
    }

    // Helper to get selected vendor name (to use in your form submission)
    function getSelectedVendor() {
        const input = document.getElementById("vendorSearch");
        return input?.dataset.value || input?.value || "";
    }

</script>